<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title th:text="${prodotto.nome}">Dettagli Prodotto</title>
		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/prodotto.css">
	</head>
	<body>
		<h1 th:text="${prodotto.nome}">Dettagli Prodotto</h1>
		<p th:text="${prodotto.descrizione}">Descrizione Prodotto</p>
		<p>Prezzo: <span th:text="${prodotto.prezzo}">0.00</span> â‚¬</p>
		<img th:src="@{${prodotto.fullImageUrl}}" alt="Immagine Prodotto">
		<h2>Prodotti simili</h2>
		<ul>
			<li th:each="prodottoSimile : ${prodottiSimili}">
				<a th:href="@{'/prodotti/' + ${prodottoSimile.id}}" th:text="${prodottoSimile.nome}">Nome Prodotto Simile</a>
			</li>
		</ul>
		<h3>Commenti</h3>
		<h4><span th:text="${#lists.size(prodotto.commenti)}">0</span> commenti</h4>
		<form th:action="@{'/prodotti/' + ${prodotto.id} + '/commenta'}" method="post" id="commentForm">
			<div id="commentInput" contenteditable="true" data-placeholder="Scrivi un commento..."></div>
			<input type="hidden" name="contenuto" id="hiddenContent" required><br>
			<button type="submit">Invia</button>
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
		</form>
		<!-- Sezione commenti modificata -->
		<div th:unless="${#lists.isEmpty(prodotto.commenti)}" id="commentList">
			<ul>
				<li th:each="commento : ${prodotto.commenti}" class="comment-item">
					
					<!-- Nome utente -->
					<strong th:text="${commento.autore.username}">Autore</strong>
					
					<!-- Contenuto del commento -->
					<div class="comment-content">
						<!-- Testo del commento (visibile normalmente) -->
						<span class="comment-text" th:id="'comment-text-' + ${commento.id}" th:text="${commento.testo}">Contenuto</span>
						
						<!-- Form di modifica (nascosto di default) -->
						<form th:if="${utente != null and utente.id == commento.autore.id}" class="edit-form" th:id="'edit-form-' + ${commento.id}" th:action="@{/commenti/{id}/edit(id=${commento.id})}" method="post" style="display: none;">
							<textarea class="edit-textarea" name="testo" th:text="${commento.testo}" placeholder="Modifica il tuo commento..."></textarea>
							<div>
								<button type="submit">Salva</button>
								<button type="button" th:onclick="'cancelEdit(' + ${commento.id} + ')'">Annulla</button>
							</div>
						</form>
					</div>
					
					<!-- Pulsanti di azione (solo per i propri commenti) -->
					<div th:if="${utente != null and utente.id == commento.autore.id}" class="comment-actions">
						<button type="button" th:id="'edit-btn-' + ${commento.id}" th:onclick="'startEdit(' + ${commento.id} + ')'">Modifica</button>
					</div>
				</li>
			</ul>
		</div>

		<!-- JavaScript per gestire la modifica inline -->
		<script>
			function startEdit(commentId) {
				const commentText = document.getElementById('comment-text-' + commentId);
				const editForm = document.getElementById('edit-form-' + commentId);
				const editButton = document.getElementById('edit-btn-' + commentId);
				
				// Nascondi il testo del commento e mostra il form
				commentText.style.display = 'none';
				editForm.style.display = 'block';
				
				// Nascondi il pulsante modifica
				editButton.style.display = 'none';
				
				// Imposta il focus sulla textarea
				const textarea = editForm.querySelector('textarea');
				textarea.focus();
			}
			
			function cancelEdit(commentId) {
				const commentText = document.getElementById('comment-text-' + commentId);
				const editForm = document.getElementById('edit-form-' + commentId);
				const editButton = document.getElementById('edit-btn-' + commentId);
				
				// Mostra il testo del commento e nascondi il form
				commentText.style.display = 'block';
				editForm.style.display = 'none';
				
				// Mostra il pulsante modifica
				editButton.style.display = 'inline-block';
				
				// Ripristina il testo originale nella textarea
				const textarea = editForm.querySelector('textarea');
				const originalText = commentText.textContent;
				textarea.value = originalText;
			}
		</script>
		<footer>
			<p>&copy; 2025 Catalogo Prodotti - Progetto per Sistemi Informativi su Web</p>
			<p>Realizzato da Luca Monaco | <a href="mailto:luca.monaco04@icloud.com">Contattami</a> | <a href="https://github.com/lumon2004/catalogo-prodotti" target="_blank">GitHub</a></p>
		</footer>
		<script>
			// Gestione del form di commento
			document.addEventListener('DOMContentLoaded', function() {
				const commentInput = document.getElementById('commentInput');
				const hiddenContent = document.getElementById('hiddenContent');
				const form = document.getElementById('commentForm');
				const submitButton = form.querySelector('button[type="submit"]');
				
				// Inizialmente disabilita il button
				updateButtonState();
				
				// Funzione per aggiornare lo stato del button
				function updateButtonState() {
					const content = commentInput.innerText.trim();
					if (content.length === 0) {
						submitButton.disabled = true;
						submitButton.classList.add('disabled');
					} else {
						submitButton.disabled = false;
						submitButton.classList.remove('disabled');
					}
				}
				
				// Aggiorna il campo nascosto e lo stato del button quando il contenuto cambia
				commentInput.addEventListener('input', function() {
					hiddenContent.value = this.innerText.trim();
					if (commentInput.innerText.trim().length === 0) {
						commentInput.innerHTML = '';
					}
					updateButtonState();
				});
				
				// Aggiorna anche quando si perde il focus (per sicurezza)
				commentInput.addEventListener('blur', function() {
						updateButtonState();
					});
					
					// Validazione al submit
					form.addEventListener('submit', function(e) {
						const content = commentInput.innerText.trim();
						if (!content) {
							e.preventDefault();
							alert('Inserisci un commento prima di inviare!');
							commentInput.focus();
						} else {
							hiddenContent.value = content;
						}
					});
					
					// Gestisce Enter per andare a capo
					commentInput.addEventListener('keydown', function(e) {
						if (e.key === 'Enter' && !e.shiftKey) {
							// Permette di andare a capo con solo Enter
						}
					});
				});
		</script>
		<script>
			// Funzione per convertire la data in un formato "tempo fa"
			function timeAgo(date) {
				const seconds = Math.floor((new Date() - new Date(date)) / 1000);
				const intervals = [
					{ labelSing: 'secondo', labelPlur: 'secondi', seconds: 1 },
					{ labelSing: 'minuto', labelPlur: 'minuti', seconds: 60 },
					{ labelSing: 'ora', labelPlur: 'ore', seconds: 3600 },
					{ labelSing: 'giorno', labelPlur: 'giorni', seconds: 86400 },
					{ labelSing: 'mese', labelPlur: 'mesi', seconds: 2592000 },
					{ labelSing: 'anno', labelPlur: 'anni', seconds: 31536000 }
				];

				for (const i of intervals.reverse()) {
					const count = Math.floor(seconds / i.seconds);
					if (count > 0) {
						return count + ' ' + (count === 1 ? i.labelSing : i.labelPlur) + ' fa';
					}
				}
				return 'adesso';
			}

			// Aggiorna i commenti con il tempo trascorso
			document.addEventListener("DOMContentLoaded", function () {
				document.querySelectorAll('.comment-time').forEach(el => {
					const isoTime = el.getAttribute('data-timestamp');
					el.textContent = timeAgo(isoTime);
				});
			});
		</script>
	</body>
</html>